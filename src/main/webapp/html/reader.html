<!DOCTYPE html>
<html>
  <head>
    <title>Bibs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <link href="/bibs-server/resources/styles/bootstrap.min.css" rel="stylesheet">
    </head>
  <body>
<div style="margin:12px;">

    <ul class="nav nav-tabs">
	  <li class="active"><a href="#">Race day</a></li>
	  <li><a href="runners.html">Runners</a></li>
	  <li><a href="awards.html">Awards</a></li>
	  <li><a href="bibs.html">Admin</a></li>
	</ul>

	<div style="margin-top:12px;">
	
			<button type="button" class="btn btn-danger" 
				style="margin:2px;float:left;" id="gun-button"
				onclick="gunTime();">Fire gun!</button>
				
			<input type="text" class="form-control" id="timerStart"
			     	placeholder="Start Time (ex. 08:01:23)" 
			     	style="width:200px;margin-top:2px;display:inline;"
			     	onfocus="setStartTime()"/>
	
			<button type="button" class="btn btn-danger" 
				style="margin:2px;float:left;display:none;" id="starttime-button"
				onclick="gunTime();">Set Start Time</button>
			     	
	
			<button type="button" class="btn btn-success" 
				style="margin:2px;display:none;" id="start-button"
				onclick="startTimer();">Start Finish Line Reader</button>
			<button type="button" class="btn btn-success" 
				style="margin:2px;display:none;" id="restart-button"
				onclick="restartTimer();">Re-Start Finish Line Reader</button>
			<button type="button" class="btn btn-danger" 
				style="margin:2px;display:none;" id="stop-button"
				onclick="stopTimer();">Stop Finish Line Reader</button>
			<button type="button" class="btn" 
				style="margin:2px;" id="purge-button"
				onclick="resetTimer();">Reset</button>
			
			<button type="button" class="btn" 
				style="margin:2px;display:none;" id="status"
				>Scanning for Runners...</button>
			
	</div>
	
			<div id="runners-count-div" style="display:none;">
				<span id="runners-count"></span> Total Runners
			</div>
			
<div id="results-none" class="row" 
	style="margin:30px;display:none;">
	<h5>Results will be shown here in real-time...</h5>
</div>

<div id="results" class="row" style="margin-top:15px;display:none;">
	<table id="raceresults" class="table"></table>
</div>

</div>

<script src="../scripts/jquery-1.10.2.min.js"></script>
<script src="../scripts/bootstrap.min.js"></script>

<script>
var timerOn=false;
//getRunnersCount();

// unload stop reader
$( window ).unload(function() {
	stopTimer();
});

function setStartTime(){
	var date = new Date();
	$("#gun-button").hide(500);
	$("#starttime-button").show(500);
}


function gunTime(){
	var date = new Date();
	$("#timerStart").val(date.getHours()+":"+date.getMinutes()+":"+date.getSeconds() );
	$("#timerStart").css("width","100");
	//$("#timerStart").attr("disabled","disabled");
	gun();
	$("#restart-button").hide();
	$("#stop-button").hide();
	$("#start-button").show(500);
}

function startTimer(){
	timerOn=true;
	var request = $.ajax({
		url: "/bibs-server/events/start",
		type: "GET",
		dataType: "html"
		});
	request.done(function( msg ) {
		if(msg != "true"){
			alert("Failed.");
		}else{
			$("#start-button").hide(500);
			$("#stop-button").show(500);
			$("#status").show();
			if($("#raceresults").html()=="") $("#results-none").show(500);
			setInterval(pollResults, 3000); // every millisecond call updateDisplay
		}
		});
	request.fail(function( jqXHR, textStatus ) {
		alert( "Request failed: " + textStatus );
		});
}


function resetTimer(){
	timerOn=true;
	var request = $.ajax({
		url: "/bibs-server/events/purgetimer",
		type: "GET",
		dataType: "html"
		});
	request.done(function( msg ) {
		if(msg != "true"){
			alert("Failed.");
		}else{
			$("#start-button").hide();
			$("#restart-button").hide();
			$("#stop-button").hide();
			$("#status").hide();
			$("#raceresults").empty(); 
		}
		});
	request.fail(function( jqXHR, textStatus ) {
		alert( "Request failed: " + textStatus );
		});
}function restartTimer(){
	timerOn=true;
	var request = $.ajax({
		url: "/bibs-server/events/restart",
		type: "GET",
		dataType: "html"
		});
	request.done(function( msg ) {
		if(msg != "true"){
			alert("Failed.");
		}else{
			$("#restart-button").hide(500);
			$("#stop-button").show(500);
			$("#status").show();
			$("#raceresults").empty(); 
			$("#results-none").show(500);
			setInterval(pollResults, 3000); // every millisecond call updateDisplay
		}
		});
	request.fail(function( jqXHR, textStatus ) {
		alert( "Request failed: " + textStatus );
		});
}

function stopTimer(){
	timerOn=false;
	var request = $.ajax({
		url: "/bibs-server/events/stop",
		type: "GET",
		dataType: "html"
		});
	request.done(function( msg ) {
		if(msg != "true") alert("Failed.");
		$("#restart-button").show(500);
		$("#stop-button").hide(500);
		$("#status").hide();
		});
	request.fail(function( jqXHR, textStatus ) {
		alert( "Request failed: " + textStatus );
		});
}

function getRunnersCount(){
	var request = $.ajax({
		url: "/bibs-server/raceresults/count/",
		type: "GET",
		data: {event:19},
		dataType: "html"
		});
	request.done(function( data ) {
		$('#runners-count').html(data);
		$('#runners-count-div').show(500);
		});
	request.fail(function( jqXHR, textStatus ) {
		alert( "Error: " + textStatus );
		});
}

function gun(){
	var request = $.ajax({
		url: "/bibs-server/events/gun",
		type: "GET",
		data: {event:19},
		dataType: "html"
		});
	request.done(function( data ) {
		if(data != "true") alert("Failed.");
		else alert("Race Started!")
		});
	request.fail(function( jqXHR, textStatus ) {
		alert( "Error: " + textStatus );
		});
}

function pollResults(){
	if(!timerOn) return;
	var request = $.ajax({
		url: "/bibs-server/events/results/",
		type: "GET",
		data: {event:19},
		dataType: "json"
		});
	request.done(function( data ) {
		if(data.len == 0) return;
		makeTable($('#raceresults'),data);
		$('#results').show(500);
		$("#results-none").hide(500);
		});
	request.fail(function( jqXHR, textStatus ) {
		alert( "Error: " + textStatus );
		});
}

function makeTable(tableElement,data){
	for(var i in data){
		var newResults = "";
		newResults += "<tr>";
		newResults += "<td>"+data[i].bib+"</td>";
		newResults += "<td>"+data[i].timeoverall+"</td>";
		newResults += "<td>"+data[i].firstname+" "+data[i].lastname+"</td>";
		newResults += "<td>"+data[i].city+", "+data[i].state+"</td>";
		newResults += "<td>"+data[i].gender+"</td>";
		newResults += "<td>"+data[i].age+"</td>";
		newResults += "</tr>";
		tableElement.prepend(newResults);
	}
	return;
}
</script>

  </body>
</html>
